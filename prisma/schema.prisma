// Prisma Schema para el proyecto
// Documentación: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// GEOGRAFÍA - Países, Provincias y Ciudades
// ============================================

model Country {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  code      String   @unique // ISO 3166-1 alpha-2 (AR, BR, CL, etc.)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  employees Employee[]

  @@map("countries")
}

model Province {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  cities    City[]
  companies Company[]
  employees Employee[]

  @@map("provinces")
}

model City {
  id        Int      @id @default(autoincrement())
  name      String
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  provinceId Int       @map("province_id")
  province   Province  @relation(fields: [provinceId], references: [id], onDelete: Cascade)
  companies  Company[]
  employees          Employee[]
  employeesBornHere  Employee[] @relation("EmployeeBirthPlace")

  @@unique([name, provinceId])
  @@map("cities")
}

// ============================================
// EMPRESAS Y MIEMBROS
// ============================================

// Tipo de Contribuyente
enum TaxStatus {
  RESPONSABLE_INSCRIPTO
  MONOTRIBUTO
  EXENTO

  @@map("tax_status")
}

model Company {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String
  slug         String?   @unique
  taxId        String?   @unique @map("tax_id") // CUIT/RUT/etc
  taxStatus    TaxStatus? @map("tax_status")
  description  String?
  website      String?
  email        String?
  phone        String?
  address      String?
  country      String?
  industry     String?
  logoUrl         String?  @map("logo_url")
  isActive        Boolean  @default(true) @map("is_active")
  isSingleCompany Boolean  @default(false) @map("is_single_company") // Modo empresa única - sin selector de empresas
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relaciones geográficas
  provinceId Int?      @map("province_id")
  province   Province? @relation(fields: [provinceId], references: [id])
  cityId     Int?      @map("city_id")
  city       City?     @relation(fields: [cityId], references: [id])

  // Relaciones
  members     CompanyMember[]
  invitations CompanyInvitation[]
  roles       CompanyRole[]

  // Relaciones con catálogos laborales
  contractTypes ContractType[]
  jobPositions  JobPosition[]
  unions        Union[]
  costCenters   CostCenter[]
  employees     Employee[]

  // Relaciones con catálogos de vehículos
  vehicleBrands   VehicleBrand[]
  vehicleTypes    VehicleType[]
  typesOfVehicles TypeOfVehicle[]
  sectors         Sector[]
  typeOperatives  TypeOperative[]
  contractors     Contractor[]
  equipmentOwners EquipmentOwner[]
  vehicles        Vehicle[]

  // Documentos
  documentTypes    DocumentType[]
  companyDocuments CompanyDocument[]

  // Módulo Comercial
  leads             Lead[]
  contacts          Contact[]
  quotes            Quote[]
  suppliers         Supplier[]
  productCategories ProductCategory[]
  products          Product[]
  priceLists        PriceList[]
  warehouses        Warehouse[]
  stockMovements    StockMovement[]
  salesPointsOfSale SalesPointOfSale[]
  salesInvoices     SalesInvoice[]
  purchaseInvoices  PurchaseInvoice[]
  purchaseOrders    PurchaseOrder[]
  purchaseOrderInstallments PurchaseOrderInstallment[]

  // Módulo Tesorería
  cashRegisters         CashRegister[]
  cashRegisterSessions  CashRegisterSession[]
  cashMovements         CashMovement[]
  bankAccounts          BankAccount[]
  bankMovements         BankMovement[]
  receipts              Receipt[]
  paymentOrders         PaymentOrder[]

  // Módulo Contable
  accounts            Account[]
  journalEntries     JournalEntry[]
  accountingSettings AccountingSettings?
  recurringEntries   RecurringEntry[]
  salesCreditNoteApplications     SalesCreditNoteApplication[]
  purchaseCreditNoteApplications  PurchaseCreditNoteApplication[]

  // Módulo Gastos
  expenseCategories  ExpenseCategory[]
  expenses           Expense[]

  // Cheques y Proyecciones
  checks              Check[]
  cashflowProjections CashflowProjection[]
  projectionDocumentLinks ProjectionDocumentLink[]

  // Remitos de Recepcion
  receivingNotes      ReceivingNote[]

  @@map("companies")
}

// ============================================
// MÓDULO CONTABLE
// ============================================

// Tipo de Cuenta Contable
enum AccountType {
  ASSET          // Activo
  LIABILITY      // Pasivo
  EQUITY         // Patrimonio Neto
  REVENUE        // Ingresos
  EXPENSE        // Gastos

  @@map("account_type")
}

// Naturaleza de la Cuenta (Saldo)
enum AccountNature {
  DEBIT          // Saldo Deudor
  CREDIT         // Saldo Acreedor

  @@map("account_nature")
}

// Estado del Asiento Contable
enum JournalEntryStatus {
  DRAFT         // Borrador
  POSTED        // Registrado
  REVERSED      // Anulado

  @@map("journal_entry_status")
}

// Frecuencia de Asientos Recurrentes
enum RecurringFrequency {
  MONTHLY       // Mensual
  BIMONTHLY     // Bimestral
  QUARTERLY     // Trimestral
  SEMIANNUAL    // Semestral
  ANNUAL        // Anual

  @@map("recurring_frequency")
}

// Plan de Cuentas
model Account {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId   String      @map("company_id") @db.Uuid
  code        String      // Código contable (ej: 1.1.1)
  name        String      // Nombre de la cuenta
  type        AccountType
  nature      AccountNature
  description String?
  parentId    String?     @map("parent_id") @db.Uuid
  parent      Account?    @relation("AccountHierarchy", fields: [parentId], references: [id])
  children    Account[]   @relation("AccountHierarchy")
  isActive    Boolean     @default(true) @map("is_active")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  entries     JournalEntryLine[]
  suppliers   Supplier[]     // Relación con proveedores (para cuentas predeterminadas)
  contractors Contractor[]   // Relación con clientes/contratistas (para cuentas predeterminadas)
  bankAccounts BankAccount[]  // Relación con cuentas bancarias (para cuentas contables)
  cashRegisters CashRegister[] // Relación con cajas (para cuentas contables)

  // Relaciones inversas para AccountingSettings (many-to-one)
  settingsAsSalesAccount        AccountingSettings[] @relation("SalesAccount")
  settingsAsPurchasesAccount    AccountingSettings[] @relation("PurchasesAccount")
  settingsAsReceivablesAccount  AccountingSettings[] @relation("ReceivablesAccount")
  settingsAsPayablesAccount     AccountingSettings[] @relation("PayablesAccount")
  settingsAsVatDebitAccount     AccountingSettings[] @relation("VatDebitAccount")
  settingsAsVatCreditAccount    AccountingSettings[] @relation("VatCreditAccount")
  settingsAsDefaultCashAccount  AccountingSettings[] @relation("DefaultCashAccount")
  settingsAsDefaultBankAccount  AccountingSettings[] @relation("DefaultBankAccount")
  settingsAsExpensesAccount     AccountingSettings[] @relation("ExpensesAccount")
  settingsAsResultAccount       AccountingSettings[] @relation("ResultAccount")
  settingsAsWhIvaEmitted        AccountingSettings[] @relation("WhIvaEmittedAccount")
  settingsAsWhGananciasEmitted  AccountingSettings[] @relation("WhGananciasEmittedAccount")
  settingsAsWhIibbEmitted       AccountingSettings[] @relation("WhIibbEmittedAccount")
  settingsAsWhSussEmitted       AccountingSettings[] @relation("WhSussEmittedAccount")
  settingsAsWhIvaSuffered       AccountingSettings[] @relation("WhIvaSufferedAccount")
  settingsAsWhGananciasSuffered AccountingSettings[] @relation("WhGananciasSufferedAccount")
  settingsAsWhIibbSuffered      AccountingSettings[] @relation("WhIibbSufferedAccount")
  settingsAsWhSussSuffered      AccountingSettings[] @relation("WhSussSufferedAccount")
  recurringEntryLines           RecurringEntryLine[]

  @@unique([companyId, code])
  @@map("accounts")
}

// Asientos Contables
model JournalEntry {
  id              String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId       String              @map("company_id") @db.Uuid
  number          Int                 // Número de asiento
  date            DateTime
  description     String
  status          JournalEntryStatus  @default(DRAFT)
  postDate        DateTime?           @map("post_date")

  // Campos de auditoría para reversiones
  originalEntryId String?             @map("original_entry_id") @db.Uuid
  reversalEntryId String?             @map("reversal_entry_id") @db.Uuid
  reversedBy      String?             @map("reversed_by")
  reversedAt      DateTime?           @map("reversed_at")

  company         Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  lines           JournalEntryLine[]
  salesInvoices   SalesInvoice[]
  purchaseInvoices PurchaseInvoice[]
  receipts        Receipt[]
  paymentOrders   PaymentOrder[]
  expenses        Expense[]
  createdBy       String              @map("created_by") // userId
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  // Relaciones de trazabilidad (self-referencing opcional)
  originalEntry   JournalEntry?       @relation("ReversalOriginal", fields: [originalEntryId], references: [id], onDelete: SetNull)
  reversalOf      JournalEntry[]      @relation("ReversalOriginal")
  reversalEntry   JournalEntry?       @relation("ReversalLink", fields: [reversalEntryId], references: [id], onDelete: SetNull)
  reversedBy_     JournalEntry[]      @relation("ReversalLink")

  @@unique([companyId, number])
  @@map("journal_entries")
}

// Líneas de Asiento
model JournalEntryLine {
  id            String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  entryId       String      @map("entry_id") @db.Uuid
  accountId     String      @map("account_id") @db.Uuid
  description   String?
  debit         Decimal     @default(0) @db.Decimal(12, 2)
  credit        Decimal     @default(0) @db.Decimal(12, 2)
  entry         JournalEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  account       Account     @relation(fields: [accountId], references: [id])

  @@map("journal_entry_lines")
}

// Configuración Contable por Empresa
model AccountingSettings {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId         String   @unique @map("company_id") @db.Uuid
  fiscalYearStart   DateTime @map("fiscal_year_start")
  fiscalYearEnd     DateTime @map("fiscal_year_end")
  lastEntryNumber   Int      @default(0) @map("last_entry_number")

  // Cuentas por defecto para integración con módulo comercial
  salesAccountId          String? @map("sales_account_id") @db.Uuid          // Ventas (ingreso)
  purchasesAccountId      String? @map("purchases_account_id") @db.Uuid      // Compras (gasto)
  receivablesAccountId    String? @map("receivables_account_id") @db.Uuid    // Cuentas por Cobrar
  payablesAccountId       String? @map("payables_account_id") @db.Uuid       // Cuentas por Pagar
  vatDebitAccountId       String? @map("vat_debit_account_id") @db.Uuid      // IVA Débito Fiscal (ventas)
  vatCreditAccountId      String? @map("vat_credit_account_id") @db.Uuid     // IVA Crédito Fiscal (compras)
  defaultCashAccountId    String? @map("default_cash_account_id") @db.Uuid   // Caja por defecto
  defaultBankAccountId    String? @map("default_bank_account_id") @db.Uuid   // Banco por defecto

  // Cuenta de gastos operativos (para módulo de gastos)
  expensesAccountId       String? @map("expenses_account_id") @db.Uuid      // Gastos operativos

  // Cuenta de resultado del ejercicio (para cierre fiscal)
  resultAccountId         String? @map("result_account_id") @db.Uuid        // Resultado del Ejercicio (patrimonio)

  // Cuentas de Retenciones - Emitidas (pasivo, por pagar a AFIP)
  withholdingIvaEmittedAccountId        String? @map("withholding_iva_emitted_account_id") @db.Uuid
  withholdingGananciasEmittedAccountId  String? @map("withholding_ganancias_emitted_account_id") @db.Uuid
  withholdingIibbEmittedAccountId       String? @map("withholding_iibb_emitted_account_id") @db.Uuid
  withholdingSussEmittedAccountId       String? @map("withholding_suss_emitted_account_id") @db.Uuid

  // Cuentas de Retenciones - Sufridas (activo, crédito fiscal)
  withholdingIvaSufferedAccountId       String? @map("withholding_iva_suffered_account_id") @db.Uuid
  withholdingGananciasSufferedAccountId String? @map("withholding_ganancias_suffered_account_id") @db.Uuid
  withholdingIibbSufferedAccountId      String? @map("withholding_iibb_suffered_account_id") @db.Uuid
  withholdingSussSufferedAccountId      String? @map("withholding_suss_suffered_account_id") @db.Uuid

  company                 Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  salesAccount            Account?        @relation("SalesAccount", fields: [salesAccountId], references: [id])
  purchasesAccount        Account?        @relation("PurchasesAccount", fields: [purchasesAccountId], references: [id])
  receivablesAccount      Account?        @relation("ReceivablesAccount", fields: [receivablesAccountId], references: [id])
  payablesAccount         Account?        @relation("PayablesAccount", fields: [payablesAccountId], references: [id])
  vatDebitAccount         Account?        @relation("VatDebitAccount", fields: [vatDebitAccountId], references: [id])
  vatCreditAccount        Account?        @relation("VatCreditAccount", fields: [vatCreditAccountId], references: [id])
  defaultCashAccount      Account?        @relation("DefaultCashAccount", fields: [defaultCashAccountId], references: [id])
  defaultBankAccount      Account?        @relation("DefaultBankAccount", fields: [defaultBankAccountId], references: [id])
  expensesAccount         Account?        @relation("ExpensesAccount", fields: [expensesAccountId], references: [id])
  resultAccount           Account?        @relation("ResultAccount", fields: [resultAccountId], references: [id])

  // Relaciones de cuentas de retenciones
  withholdingIvaEmittedAccount        Account? @relation("WhIvaEmittedAccount", fields: [withholdingIvaEmittedAccountId], references: [id])
  withholdingGananciasEmittedAccount  Account? @relation("WhGananciasEmittedAccount", fields: [withholdingGananciasEmittedAccountId], references: [id])
  withholdingIibbEmittedAccount       Account? @relation("WhIibbEmittedAccount", fields: [withholdingIibbEmittedAccountId], references: [id])
  withholdingSussEmittedAccount       Account? @relation("WhSussEmittedAccount", fields: [withholdingSussEmittedAccountId], references: [id])
  withholdingIvaSufferedAccount       Account? @relation("WhIvaSufferedAccount", fields: [withholdingIvaSufferedAccountId], references: [id])
  withholdingGananciasSufferedAccount Account? @relation("WhGananciasSufferedAccount", fields: [withholdingGananciasSufferedAccountId], references: [id])
  withholdingIibbSufferedAccount      Account? @relation("WhIibbSufferedAccount", fields: [withholdingIibbSufferedAccountId], references: [id])
  withholdingSussSufferedAccount      Account? @relation("WhSussSufferedAccount", fields: [withholdingSussSufferedAccountId], references: [id])

  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  @@map("accounting_settings")
}

model CompanyMember {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @map("user_id") // Clerk user ID
  isOwner   Boolean   @default(false) @map("is_owner")
  isActive  Boolean   @default(true) @map("is_active")
  invitedBy String?   @map("invited_by") // Clerk user ID de quien invitó
  joinedAt  DateTime? @map("joined_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relaciones
  companyId String  @map("company_id") @db.Uuid
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Rol del miembro
  roleId String?      @map("role_id") @db.Uuid
  role   CompanyRole? @relation(fields: [roleId], references: [id])

  // Vinculación opcional con empleado
  employeeId String?   @unique @map("employee_id") @db.Uuid
  employee   Employee? @relation(fields: [employeeId], references: [id])

  // Permisos individuales (override)
  permissions CompanyMemberPermission[]

  @@unique([companyId, userId])
  @@map("company_members")
}

model CompanyInvitation {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email      String
  role       String    @default("member") // Temporal hasta implementar roles
  token      String    @unique @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invitedBy  String    @map("invited_by") // Clerk user ID
  expiresAt  DateTime  @map("expires_at")
  acceptedAt DateTime? @map("accepted_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  // Relaciones
  companyId String  @map("company_id") @db.Uuid
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Rol asignado al aceptar (se agregará en Fase 3)
  roleId String?      @map("role_id") @db.Uuid
  assignedRole   CompanyRole? @relation(fields: [roleId], references: [id])

  // Empleado a vincular cuando se acepte la invitación
  employeeId String?   @map("employee_id") @db.Uuid
  employee   Employee? @relation(fields: [employeeId], references: [id])

  @@unique([companyId, email])
  @@map("company_invitations")
}

// ============================================
// PREFERENCIAS DE USUARIO
// ============================================

model UserPreference {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @unique @map("user_id") // Clerk user ID
  activeCompanyId String?  @map("active_company_id") @db.Uuid
  theme           String   @default("system")
  locale          String   @default("es")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("user_preferences")
}

// ============================================
// SISTEMA DE ROLES Y PERMISOS POR EMPRESA
// ============================================

// Rutas del sistema (definición global) - Ya no se usa para permisos, solo como catálogo de navegación
model Route {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  module      String   // "employees", "equipment", "company"
  path        String   @unique // "/dashboard/employees"
  name        String   // "Lista de Empleados"
  description String?
  parentPath  String?  @map("parent_path") // Para subrutas
  orderIndex  Int      @default(0) @map("order_index")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("routes")
}

// Acciones disponibles (CRUD)
model Action {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @unique // "Ver", "Crear", "Editar", "Eliminar"
  slug        String   @unique // "view", "create", "update", "delete"
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relaciones
  rolePermissions   CompanyRolePermission[]
  memberPermissions CompanyMemberPermission[]

  @@map("actions")
}

// Roles por empresa
model CompanyRole {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   // "Administrador", "Usuario"
  slug        String?
  description String?
  color       String?  // Para UI
  isDefault   Boolean  @default(false) @map("is_default") // Rol para nuevos miembros
  isSystem    Boolean  @default(false) @map("is_system") // owner/admin, no eliminables
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relaciones
  companyId String  @map("company_id") @db.Uuid
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  permissions CompanyRolePermission[]
  members     CompanyMember[]
  invitations CompanyInvitation[]

  @@unique([companyId, slug])
  @@map("company_roles")
}

// Permisos de cada rol por módulo
model CompanyRolePermission {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  module    String   // "employees", "company.cost-centers", "commercial.clients", etc.
  createdAt DateTime @default(now()) @map("created_at")

  // Relaciones
  roleId   String      @map("role_id") @db.Uuid
  role     CompanyRole @relation(fields: [roleId], references: [id], onDelete: Cascade)
  actionId String      @map("action_id") @db.Uuid
  action   Action      @relation(fields: [actionId], references: [id], onDelete: Cascade)

  @@unique([roleId, module, actionId])
  @@map("company_role_permissions")
}

// Override de permisos individuales por miembro
model CompanyMemberPermission {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  module     String   // "employees", "company.cost-centers", etc.
  isGranted  Boolean  @default(true) @map("is_granted") // true=concede, false=revoca
  assignedBy String?  @map("assigned_by") // Clerk user ID
  createdAt  DateTime @default(now()) @map("created_at")

  // Relaciones
  memberId String        @map("member_id") @db.Uuid
  member   CompanyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  actionId String        @map("action_id") @db.Uuid
  action   Action        @relation(fields: [actionId], references: [id], onDelete: Cascade)

  @@unique([memberId, module, actionId])
  @@map("company_member_permissions")
}

// Auditoría de cambios en permisos
model PermissionAuditLog {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId   String   @map("company_id") @db.Uuid
  performedBy String   @map("performed_by") // Clerk user ID
  action      String   // "role_created", "role_updated", "permission_granted", "permission_revoked", etc.
  targetType  String   @map("target_type") // "role", "member", "invitation"
  targetId    String   @map("target_id") @db.Uuid
  targetName  String?  @map("target_name")
  module      String?
  details     Json?    @db.JsonB
  oldValue    Json?    @map("old_value") @db.JsonB
  newValue    Json?    @map("new_value") @db.JsonB
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([companyId, createdAt(sort: Desc)])
  @@map("permission_audit_logs")
}

// ============================================
// CATÁLOGOS LABORALES (por empresa)
// ============================================

// Tipos de Contrato
model ContractType {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   // "Tiempo Indeterminado", "Período de prueba"
  code        String?  // "008", "014", "022"
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relaciones
  companyId String  @map("company_id") @db.Uuid
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  employees              Employee[]
  documentTypeConditions DocumentTypeContractType[]

  @@unique([companyId, name])
  @@map("contract_types")
}

// Puestos de Trabajo
model JobPosition {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   // "Supervisor", "Chofer de 1°", "ATG"
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relaciones
  companyId String  @map("company_id") @db.Uuid
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  employees               Employee[]
  documentTypeConditions  DocumentTypeJobPosition[]

  @@unique([companyId, name])
  @@map("job_positions")
}

// Gremios/Sindicatos
model Union {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String   // "Sindicato de Camioneros NQN"
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  companyId String  @map("company_id") @db.Uuid
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  collectiveAgreements   CollectiveAgreement[]
  documentTypeConditions DocumentTypeUnion[]

  @@unique([companyId, name])
  @@map("unions")
}

// Convenios Colectivos
model CollectiveAgreement {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String   // "40/89", "644/12"
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  unionId String @map("union_id") @db.Uuid
  union   Union  @relation(fields: [unionId], references: [id], onDelete: Cascade)

  jobCategories          JobCategory[]
  documentTypeConditions DocumentTypeCollectiveAgreement[]

  @@unique([unionId, name])
  @@map("collective_agreements")
}

// Categorías Laborales
model JobCategory {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String   // "Chofer 1° Cat", "Administrativo 1°"
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  agreementId String              @map("agreement_id") @db.Uuid
  agreement   CollectiveAgreement @relation(fields: [agreementId], references: [id], onDelete: Cascade)

  employees              Employee[]
  documentTypeConditions DocumentTypeJobCategory[]

  @@unique([agreementId, name])
  @@map("job_categories")
}

// Centros de Costo
model CostCenter {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String   // "Logística", "Mantenimiento", "Administración"
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  companyId String  @map("company_id") @db.Uuid
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  employees Employee[]
  vehicles  Vehicle[]

  @@unique([companyId, name])
  @@map("cost_centers")
}

// ============================================
// CATÁLOGOS DE VEHÍCULOS/EQUIPOS (por empresa)
// ============================================

// Marcas de Vehículos
model VehicleBrand {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String   // "Scania", "Volvo", "Mercedes-Benz"
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  companyId String  @map("company_id") @db.Uuid
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  models                 VehicleModel[]
  vehicles               Vehicle[]
  documentTypeConditions DocumentTypeVehicleBrand[]

  @@unique([companyId, name])
  @@map("vehicle_brands")
}

// Modelos de Vehículos (por marca)
model VehicleModel {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String   // "R450", "FH 540", "Actros"
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  brandId String       @map("brand_id") @db.Uuid
  brand   VehicleBrand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  vehicles Vehicle[]

  @@unique([brandId, name])
  @@map("vehicle_models")
}

// Tipos de Equipo (Camión, Semirremolque, Acoplado, etc.)
model VehicleType {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String   // "Camión", "Semirremolque", "Acoplado"
  hasHitch     Boolean  @default(false) @map("has_hitch") // Tiene enganche
  isTractorUnit Boolean @default(false) @map("is_tractor_unit") // Es unidad tractora
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relaciones
  companyId String  @map("company_id") @db.Uuid
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  vehicles               Vehicle[]
  documentTypeConditions DocumentTypeVehicleType[]

  @@unique([companyId, name])
  @@map("vehicle_types")
}

// Clasificación de Vehículo (Vehículo vs Otros equipos)
model TypeOfVehicle {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String   // "Vehículos", "Otros"
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  companyId String  @map("company_id") @db.Uuid
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  vehicles Vehicle[]

  @@unique([companyId, name])
  @@map("types_of_vehicles")
}

// Sectores de Operación
model Sector {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name             String   // "Norte", "Sur", "Centro"
  shortDescription String?  @map("short_description")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relaciones
  companyId String  @map("company_id") @db.Uuid
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  vehicles Vehicle[]

  @@unique([companyId, name])
  @@map("sectors")
}

// Tipos Operativos
model TypeOperative {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String   // "Larga distancia", "Distribución", "Urbano"
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  companyId String  @map("company_id") @db.Uuid
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  vehicles Vehicle[]

  @@unique([companyId, name])
  @@map("type_operatives")
}

// Titulares de Equipos (dueños/locadores)
model EquipmentOwner {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String   // Razón social
  cuit      String   // CUIT del titular
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  companyId String  @map("company_id") @db.Uuid
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Tipos de titularidad que ofrece este titular
  titularityTypes EquipmentOwnerTitularityType[]

  // Vehículos de este titular
  vehicles Vehicle[]

  @@unique([companyId, cuit])
  @@map("equipment_owners")
}

// Tipos de titularidad que ofrece cada titular (un owner puede ofrecer Leasing, Alquiler, etc.)
model EquipmentOwnerTitularityType {
  id             String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  titularityType VehicleTitularityType @map("titularity_type")
  createdAt      DateTime              @default(now()) @map("created_at")

  // Relaciones
  ownerId String         @map("owner_id") @db.Uuid
  owner   EquipmentOwner @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@unique([ownerId, titularityType])
  @@map("equipment_owner_titularity_types")
}

// Contratistas/Clientes (a los que se asignan vehículos y empleados)
model Contractor {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                 String    // "YPF S.A.", "Petrolera Aconcagua"
  taxId                String?   @map("tax_id") // CUIT
  email                String?
  phone                String?
  address              String?
  logoKey              String?   @map("logo_key") // Key en S3/MinIO para el logo
  isActive             Boolean   @default(true) @map("is_active")
  terminationDate      DateTime? @map("termination_date")
  reasonForTermination String?   @map("reason_for_termination")

  // Campos comerciales (agregados para módulo comercial)
  taxCondition      CustomerTaxCondition @default(CONSUMIDOR_FINAL) @map("tax_condition")
  paymentTermDays   Int                  @default(0) @map("payment_term_days")
  creditLimit       Decimal?             @map("credit_limit") @db.Decimal(12, 2)
  priceListId       String?              @map("price_list_id") @db.Uuid
  defaultAccountId  String?              @map("default_account_id") @db.Uuid

  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  // Relaciones
  companyId String  @map("company_id") @db.Uuid
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Relaciones comerciales
  priceList         PriceList? @relation(fields: [priceListId], references: [id])
  defaultAccount    Account?   @relation(fields: [defaultAccountId], references: [id])

  vehicleAllocations  ContractorVehicle[]
  employeeAllocations ContractorEmployee[]
  convertedFromLeads  Lead[]
  contact             Contact?
  quotes              Quote[]
  salesInvoices       SalesInvoice[]
  receipts            Receipt[]
  checks              Check[]

  @@unique([companyId, name])
  @@unique([companyId, taxId])
  @@map("contractors")
}

// Tabla intermedia: Asignación de vehículos a contratistas
model ContractorVehicle {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  // Relaciones
  vehicleId    String     @map("vehicle_id") @db.Uuid
  vehicle      Vehicle    @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  contractorId String     @map("contractor_id") @db.Uuid
  contractor   Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  @@unique([vehicleId, contractorId])
  @@map("contractor_vehicles")
}

// Tabla intermedia: Asignación de empleados a contratistas/clientes
model ContractorEmployee {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  // Relaciones
  employeeId   String     @map("employee_id") @db.Uuid
  employee     Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  contractorId String     @map("contractor_id") @db.Uuid
  contractor   Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  @@unique([employeeId, contractorId])
  @@map("contractor_employees")
}

// ============================================
// MÓDULO COMERCIAL - Leads, Contactos, Presupuestos
// ============================================

// Estado del Lead
enum LeadStatus {
  NEW         // Nuevo
  CONTACTED   // Contactado
  NEGOTIATING // En negociación
  CONVERTED   // Convertido a cliente
  REJECTED    // Rechazado
  INACTIVE    // Inactivo

  @@map("lead_status")
}

// Lead (prospecto que puede convertirse en cliente/contratista)
model Lead {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  taxId       String?    @map("tax_id")
  email       String?
  phone       String?
  address     String?
  status      LeadStatus @default(NEW)
  notes       String?
  convertedAt DateTime?  @map("converted_at")
  isActive    Boolean    @default(true) @map("is_active")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Relaciones
  companyId           String      @map("company_id") @db.Uuid
  company             Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  convertedToClientId String?     @map("converted_to_client_id") @db.Uuid
  convertedToClient   Contractor? @relation(fields: [convertedToClientId], references: [id])

  // Contacto principal del lead
  contact Contact?

  @@unique([companyId, taxId])
  @@map("leads")
}

// Contacto (persona de contacto de un cliente o lead)
model Contact {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  email     String?
  phone     String?
  position  String?  // Cargo en la empresa
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  companyId String  @map("company_id") @db.Uuid
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Un contacto pertenece a un cliente O a un lead (no ambos)
  contractorId String?     @unique @map("contractor_id") @db.Uuid
  contractor   Contractor? @relation(fields: [contractorId], references: [id])
  leadId       String?     @unique @map("lead_id") @db.Uuid
  lead         Lead?       @relation(fields: [leadId], references: [id])

  @@map("contacts")
}

// Estado del Presupuesto
enum QuoteStatus {
  DRAFT    // Borrador
  SENT     // Enviado
  ACCEPTED // Aceptado
  REJECTED // Rechazado
  EXPIRED  // Expirado

  @@map("quote_status")
}

// Presupuesto (mockup para futuro desarrollo)
model Quote {
  id             String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  number         String      // Número de presupuesto
  issueDate      DateTime    @map("issue_date")
  expirationDate DateTime?   @map("expiration_date")
  status         QuoteStatus @default(DRAFT)
  items          Json        @db.JsonB // Array de items del presupuesto
  subtotal       Decimal     @db.Decimal(12, 2)
  tax            Decimal?    @db.Decimal(12, 2)
  total          Decimal     @db.Decimal(12, 2)
  currency       Currency    @default(ARS)
  notes          String?
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  // Relaciones
  companyId    String      @map("company_id") @db.Uuid
  company      Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contractorId String?     @map("contractor_id") @db.Uuid
  contractor   Contractor? @relation(fields: [contractorId], references: [id])
  leadId       String?     @map("lead_id") @db.Uuid

  @@unique([companyId, number])
  @@map("quotes")
}

// ============================================
// DOCUMENTOS
// ============================================

// A qué tipo de entidad aplica el documento
enum DocumentAppliesTo {
  EMPLOYEE
  EQUIPMENT
  COMPANY

  @@map("document_applies_to")
}

// Estado del documento (simplificado - sin flujo de aprobación)
enum DocumentState {
  PENDING  // Sin archivo subido
  APPROVED // Documento subido y válido
  EXPIRED  // Vencido

  @@map("document_state")
}

// Acción realizada sobre un documento (para historial)
enum DocumentAction {
  UPLOADED  // Primera subida
  REPLACED  // Reemplazo (elimina archivo anterior)
  RENEWED   // Renovación (mantiene anterior en historial)
  DELETED   // Eliminación manual
  EXPIRED   // Marcado como vencido por sistema

  @@map("document_action")
}

// Tipos de Documento (catálogo por empresa)
model DocumentType {
  id            String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String            // "Licencia de conducir", "DNI", "F931"
  slug          String            // "licencia-de-conducir" - para paths de storage
  appliesTo     DocumentAppliesTo @map("applies_to")
  isMandatory   Boolean           @default(false) @map("is_mandatory")
  hasExpiration Boolean           @default(false) @map("has_expiration")
  isMonthly     Boolean           @default(false) @map("is_monthly") // Recibos, F931
  isPrivate     Boolean           @default(false) @map("is_private")
  isTermination   Boolean           @default(false) @map("is_termination") // Doc de baja
  isMultiResource Boolean           @default(false) @map("is_multi_resource") // Cubre a todos los empleados/equipos
  description     String?
  isActive      Boolean           @default(true) @map("is_active")
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")

  // Campos de condiciones
  isConditional      Boolean    @default(false) @map("is_conditional")
  genders            Gender[]   @default([])
  costTypes          CostType[] @default([])
  advancedConditions Json?      @map("advanced_conditions") @db.JsonB

  // Relaciones
  companyId String  @map("company_id") @db.Uuid
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  employeeDocuments  EmployeeDocument[]
  equipmentDocuments EquipmentDocument[]
  companyDocuments   CompanyDocument[]

  // Condiciones para EMPLOYEE
  conditionJobPositions         DocumentTypeJobPosition[]
  conditionContractTypes        DocumentTypeContractType[]
  conditionJobCategories        DocumentTypeJobCategory[]
  conditionUnions               DocumentTypeUnion[]
  conditionCollectiveAgreements DocumentTypeCollectiveAgreement[]

  // Condiciones para EQUIPMENT
  conditionVehicleBrands DocumentTypeVehicleBrand[]
  conditionVehicleTypes  DocumentTypeVehicleType[]

  @@unique([companyId, name])
  @@unique([companyId, slug])
  @@map("document_types")
}

// ============================================
// CONDICIONES DE TIPOS DE DOCUMENTO
// ============================================

// Condición: Puestos de Trabajo
model DocumentTypeJobPosition {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  documentTypeId String       @map("document_type_id") @db.Uuid
  documentType   DocumentType @relation(fields: [documentTypeId], references: [id], onDelete: Cascade)
  jobPositionId  String       @map("job_position_id") @db.Uuid
  jobPosition    JobPosition  @relation(fields: [jobPositionId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now()) @map("created_at")

  @@unique([documentTypeId, jobPositionId])
  @@map("document_type_job_positions")
}

// Condición: Tipos de Contrato
model DocumentTypeContractType {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  documentTypeId String       @map("document_type_id") @db.Uuid
  documentType   DocumentType @relation(fields: [documentTypeId], references: [id], onDelete: Cascade)
  contractTypeId String       @map("contract_type_id") @db.Uuid
  contractType   ContractType @relation(fields: [contractTypeId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now()) @map("created_at")

  @@unique([documentTypeId, contractTypeId])
  @@map("document_type_contract_types")
}

// Condición: Categorías Laborales
model DocumentTypeJobCategory {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  documentTypeId String       @map("document_type_id") @db.Uuid
  documentType   DocumentType @relation(fields: [documentTypeId], references: [id], onDelete: Cascade)
  jobCategoryId  String       @map("job_category_id") @db.Uuid
  jobCategory    JobCategory  @relation(fields: [jobCategoryId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now()) @map("created_at")

  @@unique([documentTypeId, jobCategoryId])
  @@map("document_type_job_categories")
}

// Condición: Sindicatos
model DocumentTypeUnion {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  documentTypeId String       @map("document_type_id") @db.Uuid
  documentType   DocumentType @relation(fields: [documentTypeId], references: [id], onDelete: Cascade)
  unionId        String       @map("union_id") @db.Uuid
  union          Union        @relation(fields: [unionId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now()) @map("created_at")

  @@unique([documentTypeId, unionId])
  @@map("document_type_unions")
}

// Condición: Convenios Colectivos
model DocumentTypeCollectiveAgreement {
  id                    String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  documentTypeId        String              @map("document_type_id") @db.Uuid
  documentType          DocumentType        @relation(fields: [documentTypeId], references: [id], onDelete: Cascade)
  collectiveAgreementId String              @map("collective_agreement_id") @db.Uuid
  collectiveAgreement   CollectiveAgreement @relation(fields: [collectiveAgreementId], references: [id], onDelete: Cascade)
  createdAt             DateTime            @default(now()) @map("created_at")

  @@unique([documentTypeId, collectiveAgreementId])
  @@map("document_type_collective_agreements")
}

// Condición: Marcas de Vehículo
model DocumentTypeVehicleBrand {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  documentTypeId String       @map("document_type_id") @db.Uuid
  documentType   DocumentType @relation(fields: [documentTypeId], references: [id], onDelete: Cascade)
  vehicleBrandId String       @map("vehicle_brand_id") @db.Uuid
  vehicleBrand   VehicleBrand @relation(fields: [vehicleBrandId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now()) @map("created_at")

  @@unique([documentTypeId, vehicleBrandId])
  @@map("document_type_vehicle_brands")
}

// Condición: Tipos de Vehículo
model DocumentTypeVehicleType {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  documentTypeId String       @map("document_type_id") @db.Uuid
  documentType   DocumentType @relation(fields: [documentTypeId], references: [id], onDelete: Cascade)
  vehicleTypeId  String       @map("vehicle_type_id") @db.Uuid
  vehicleType    VehicleType  @relation(fields: [vehicleTypeId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now()) @map("created_at")

  @@unique([documentTypeId, vehicleTypeId])
  @@map("document_type_vehicle_types")
}

// Documentos de Empleados
model EmployeeDocument {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  state          DocumentState @default(PENDING)
  expirationDate DateTime?     @map("expiration_date")
  period         String?       // Para documentos mensuales: "2024-01"
  documentPath   String?       @map("document_path") // URL del archivo
  documentKey    String?       @map("document_key") // Key en storage
  fileName       String?       @map("file_name") // Nombre original
  fileSize       Int?          @map("file_size") // Tamaño en bytes
  mimeType       String?       @map("mime_type")
  uploadedBy     String?       @map("uploaded_by") // Clerk user ID
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Relaciones
  documentTypeId String       @map("document_type_id") @db.Uuid
  documentType   DocumentType @relation(fields: [documentTypeId], references: [id], onDelete: Cascade)
  employeeId     String?      @map("employee_id") @db.Uuid // Nullable para documentos multirrecurso
  employee       Employee?    @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Historial de cambios
  history EmployeeDocumentHistory[]

  @@unique([documentTypeId, employeeId, period])
  @@map("employee_documents")
}

// Historial de cambios en documentos de empleados
model EmployeeDocumentHistory {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  action         DocumentAction // Tipo de acción realizada
  state          DocumentState  // Estado después de la acción
  documentKey    String?        @map("document_key") // Key del archivo en ese momento
  fileName       String?        @map("file_name")
  fileSize       Int?           @map("file_size")
  mimeType       String?        @map("mime_type")
  expirationDate DateTime?      @map("expiration_date")
  reason         String?        // Razón del cambio (opcional)
  changedBy      String         @map("changed_by") // Clerk user ID
  changedAt      DateTime       @default(now()) @map("changed_at")

  // Relación con el documento
  documentId String           @map("document_id") @db.Uuid
  document   EmployeeDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([changedAt(sort: Desc)])
  @@map("employee_document_history")
}

// Documentos de Equipos/Vehículos
model EquipmentDocument {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  state           DocumentState @default(PENDING)
  expirationDate  DateTime?     @map("expiration_date")
  period          String?
  documentPath    String?       @map("document_path")
  documentKey     String?       @map("document_key")
  fileName        String?       @map("file_name")
  fileSize        Int?          @map("file_size")
  mimeType        String?       @map("mime_type")
  rejectionReason String?       @map("rejection_reason")
  uploadedBy      String?       @map("uploaded_by")
  approvedBy      String?       @map("approved_by")
  approvedAt      DateTime?     @map("approved_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relaciones
  documentTypeId String       @map("document_type_id") @db.Uuid
  documentType   DocumentType @relation(fields: [documentTypeId], references: [id], onDelete: Cascade)
  vehicleId      String?      @map("vehicle_id") @db.Uuid // Nullable para documentos multirrecurso
  vehicle        Vehicle?     @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  // Historial de cambios
  history EquipmentDocumentHistory[]

  @@unique([documentTypeId, vehicleId, period])
  @@map("equipment_documents")
}

// Historial de cambios en documentos de equipos/vehículos
model EquipmentDocumentHistory {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  action         DocumentAction // Tipo de acción realizada
  state          DocumentState  // Estado después de la acción
  documentKey    String?        @map("document_key") // Key del archivo en ese momento
  fileName       String?        @map("file_name")
  fileSize       Int?           @map("file_size")
  mimeType       String?        @map("mime_type")
  expirationDate DateTime?      @map("expiration_date")
  reason         String?        // Razón del cambio (opcional)
  changedBy      String         @map("changed_by") // Clerk user ID
  changedAt      DateTime       @default(now()) @map("changed_at")

  // Relación con el documento
  documentId String            @map("document_id") @db.Uuid
  document   EquipmentDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([changedAt(sort: Desc)])
  @@map("equipment_document_history")
}

// Documentos de Empresa
model CompanyDocument {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  state           DocumentState @default(PENDING)
  expirationDate  DateTime?     @map("expiration_date")
  period          String?
  documentPath    String?       @map("document_path")
  documentKey     String?       @map("document_key")
  fileName        String?       @map("file_name")
  fileSize        Int?          @map("file_size")
  mimeType        String?       @map("mime_type")
  rejectionReason String?       @map("rejection_reason")
  uploadedBy      String?       @map("uploaded_by")
  approvedBy      String?       @map("approved_by")
  approvedAt      DateTime?     @map("approved_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relaciones
  documentTypeId String       @map("document_type_id") @db.Uuid
  documentType   DocumentType @relation(fields: [documentTypeId], references: [id], onDelete: Cascade)
  companyId      String       @map("company_id") @db.Uuid
  company        Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([documentTypeId, companyId, period])
  @@map("company_documents")
}

// ============================================
// EMPLEADOS
// ============================================

// Enums para empleados
enum IdentityDocumentType {
  DNI
  LE
  LC
  PASSPORT

  @@map("identity_document_type")
}

enum Gender {
  MALE
  FEMALE
  NOT_DECLARED

  @@map("gender")
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
  SEPARATED
  DOMESTIC_PARTNERSHIP

  @@map("marital_status")
}

enum EducationLevel {
  PRIMARY
  SECONDARY
  TERTIARY
  UNIVERSITY
  POSTGRADUATE

  @@map("education_level")
}

enum UnionAffiliationStatus {
  AFFILIATED
  NOT_AFFILIATED

  @@map("union_affiliation_status")
}

enum CostType {
  DIRECT
  INDIRECT

  @@map("cost_type")
}

enum EmployeeStatus {
  INCOMPLETE
  COMPLETE
  COMPLETE_EXPIRED_DOCS

  @@map("employee_status")
}

enum TerminationReason {
  DISMISSAL_WITHOUT_CAUSE
  RESIGNATION
  DISMISSAL_WITH_CAUSE
  MUTUAL_AGREEMENT
  CONTRACT_END
  DEATH

  @@map("termination_reason")
}

model Employee {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Identificación
  employeeNumber       String               @map("employee_number") // Legajo
  identityDocumentType IdentityDocumentType @default(DNI) @map("identity_document_type")
  documentNumber       String               @map("document_number")
  cuil           String       // CUIL/CUIT

  // Datos Personales
  firstName       String          @map("first_name")
  lastName        String          @map("last_name")
  birthDate       DateTime?       @map("birth_date")
  gender          Gender?
  maritalStatus   MaritalStatus?  @map("marital_status")
  educationLevel  EducationLevel? @map("education_level")
  pictureUrl      String?         @map("picture_url") // URL de la foto
  pictureKey      String?         @map("picture_key") // Clave en storage (MinIO/R2)

  // Nacionalidad
  nationalityId Int?     @map("nationality_id")
  nationality   Country? @relation(fields: [nationalityId], references: [id])

  // Contacto
  phone String
  email String?

  // Dirección
  street       String  @map("street")
  streetNumber String  @map("street_number")
  postalCode   String? @map("postal_code")
  provinceId   Int     @map("province_id")
  province     Province @relation(fields: [provinceId], references: [id])
  cityId       Int?    @map("city_id")
  city         City?   @relation(fields: [cityId], references: [id])

  // Lugar de nacimiento
  birthPlaceId Int?  @map("birth_place_id")
  birthPlace   City? @relation("EmployeeBirthPlace", fields: [birthPlaceId], references: [id])

  // Información Laboral
  hireDate              DateTime                @map("hire_date") // Fecha de ingreso
  workingHoursPerDay    Int?                    @map("working_hours_per_day")
  unionAffiliationStatus UnionAffiliationStatus? @map("union_affiliation_status")
  costType              CostType?               @map("cost_type")

  // Estado
  status            EmployeeStatus     @default(INCOMPLETE)
  isActive          Boolean            @default(true) @map("is_active")
  terminationDate   DateTime?          @map("termination_date")
  terminationReason TerminationReason? @map("termination_reason")

  // Relaciones con catálogos
  companyId      String        @map("company_id") @db.Uuid
  company        Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  jobPositionId  String?       @map("job_position_id") @db.Uuid
  jobPosition    JobPosition?  @relation(fields: [jobPositionId], references: [id])
  contractTypeId String?       @map("contract_type_id") @db.Uuid
  contractType   ContractType? @relation(fields: [contractTypeId], references: [id])
  jobCategoryId  String?       @map("job_category_id") @db.Uuid
  jobCategory    JobCategory?  @relation(fields: [jobCategoryId], references: [id])
  costCenterId   String?       @map("cost_center_id") @db.Uuid
  costCenter     CostCenter?   @relation(fields: [costCenterId], references: [id])

  // Documentos del empleado
  documents EmployeeDocument[]

  // Asignaciones a clientes/contratistas
  contractorAllocations ContractorEmployee[]

  // Vinculación con usuario del sistema (si este empleado tiene acceso)
  companyMember CompanyMember?

  // Invitaciones pendientes para este empleado
  pendingInvitations CompanyInvitation[]

  @@unique([companyId, employeeNumber])
  @@unique([companyId, cuil])
  @@map("employees")
}

// ============================================
// VEHÍCULOS/EQUIPOS
// ============================================

// Enums para vehículos
enum VehicleStatus {
  INCOMPLETE
  COMPLETE
  COMPLETE_EXPIRED_DOCS
  APPROVED
  NOT_APPROVED

  @@map("vehicle_status")
}

enum VehicleCondition {
  OPERATIVE
  NOT_OPERATIVE
  IN_REPAIR
  CONDITIONAL_OPERATIVE
  IN_PREPARATION

  @@map("vehicle_condition")
}

enum VehicleTerminationReason {
  SALE
  TOTAL_LOSS
  RETURN
  OTHER

  @@map("vehicle_termination_reason")
}

enum VehicleTitularityType {
  LEASING
  RENTAL
  OWNED
  PLEDGED

  @@map("vehicle_titularity_type")
}

enum Currency {
  USD
  EUR
  GBP
  ARS

  @@map("currency")
}

model Vehicle {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Identificación
  internNumber String? @map("intern_number") // Número interno/legajo
  domain       String? // Patente/Dominio
  chassis      String? // Número de chasis
  engine       String  // Número de motor
  serie        String? // Número de serie
  year         String  // Año del vehículo
  kilometer    String? @default("0") // Kilometraje

  // Imagen
  pictureUrl String? @map("picture_url")
  pictureKey String? @map("picture_key")

  // Estado
  status    VehicleStatus    @default(INCOMPLETE)
  condition VehicleCondition @default(OPERATIVE)
  isActive  Boolean          @default(true) @map("is_active")

  // Baja
  terminationDate   DateTime?                @map("termination_date")
  terminationReason VehicleTerminationReason? @map("termination_reason")

  // Información de titularidad/propiedad
  titularityType         VehicleTitularityType? @map("titularity_type")
  contractNumber         String?                @map("contract_number")
  contractStartDate      DateTime?              @map("contract_start_date")
  contractExpirationDate DateTime?              @map("contract_expiration_date")
  currency               Currency?
  price                  Decimal?               @db.Decimal(12, 2) // Valor del equipo
  monthlyPrice           Decimal?               @map("monthly_price") @db.Decimal(12, 2) // Valor mensual (leasing/alquiler)

  // Titular del equipo (cuando no es propio)
  ownerId String?         @map("owner_id") @db.Uuid
  owner   EquipmentOwner? @relation(fields: [ownerId], references: [id])

  // Tipo de costo
  costType CostType? @map("cost_type")

  // Relaciones con empresa
  companyId String  @map("company_id") @db.Uuid
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Relaciones con catálogos
  brandId String?       @map("brand_id") @db.Uuid
  brand   VehicleBrand? @relation(fields: [brandId], references: [id])

  modelId String?       @map("model_id") @db.Uuid
  model   VehicleModel? @relation(fields: [modelId], references: [id])

  typeId String      @map("type_id") @db.Uuid
  type   VehicleType @relation(fields: [typeId], references: [id])

  typeOfVehicleId String        @map("type_of_vehicle_id") @db.Uuid
  typeOfVehicle   TypeOfVehicle @relation(fields: [typeOfVehicleId], references: [id])

  costCenterId String?     @map("cost_center_id") @db.Uuid
  costCenter   CostCenter? @relation(fields: [costCenterId], references: [id])

  sectorId String? @map("sector_id") @db.Uuid
  sector   Sector? @relation(fields: [sectorId], references: [id])

  typeOperativeId String?        @map("type_operative_id") @db.Uuid
  typeOperative   TypeOperative? @relation(fields: [typeOperativeId], references: [id])

  // Asignación a contratistas
  contractorAllocations ContractorVehicle[]

  // Documentos del vehículo
  documents EquipmentDocument[]

  @@unique([companyId, internNumber])
  @@unique([companyId, domain])
  @@map("vehicles")
}

// ============================================
// MÓDULO COMERCIAL - Enums
// ============================================

enum SupplierTaxCondition {
  RESPONSABLE_INSCRIPTO      // Responsable Inscripto
  MONOTRIBUTISTA             // Monotributista
  EXENTO                     // Exento
  NO_RESPONSABLE            // No Responsable
  CONSUMIDOR_FINAL          // Consumidor Final

  @@map("supplier_tax_condition")
}

enum SupplierStatus {
  ACTIVE
  INACTIVE
  BLOCKED

  @@map("supplier_status")
}

enum CustomerTaxCondition {
  RESPONSABLE_INSCRIPTO
  MONOTRIBUTISTA
  EXENTO
  CONSUMIDOR_FINAL

  @@map("customer_tax_condition")
}

enum ProductType {
  PRODUCT              // Producto físico
  SERVICE              // Servicio
  COMBO                // Combo/paquete

  @@map("product_type")
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  DISCONTINUED

  @@map("product_status")
}

enum WarehouseType {
  MAIN              // Principal
  BRANCH            // Sucursal
  TRANSIT           // En tránsito
  VIRTUAL           // Virtual (servicios)

  @@map("warehouse_type")
}

enum StockMovementType {
  PURCHASE          // Compra
  SALE              // Venta
  ADJUSTMENT        // Ajuste de inventario
  TRANSFER_OUT      // Transferencia salida
  TRANSFER_IN       // Transferencia entrada
  RETURN            // Devolución
  PRODUCTION        // Producción
  LOSS              // Pérdida/merma

  @@map("stock_movement_type")
}

// ============================================
// MÓDULO COMERCIAL - Proveedores
// ============================================

model Supplier {
  id                String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId         String                @map("company_id") @db.Uuid
  code              String                // Código interno
  businessName      String                @map("business_name")  // Razón social
  tradeName         String?               @map("trade_name")     // Nombre de fantasía
  taxId             String                @map("tax_id")         // CUIT/CUIL
  taxCondition      SupplierTaxCondition  @map("tax_condition")

  // Contacto
  email             String?
  phone             String?
  website           String?

  // Dirección
  address           String?
  city              String?
  state             String?               // Provincia
  zipCode           String?               @map("zip_code")
  country           String                @default("Argentina")

  // Datos comerciales
  paymentTermDays   Int                   @default(0) @map("payment_term_days")
  creditLimit       Decimal?              @map("credit_limit") @db.Decimal(12, 2)

  // Datos contables (para integración futura)
  defaultAccountId  String?               @map("default_account_id") @db.Uuid

  // Contactos
  contactName       String?               @map("contact_name")
  contactPhone      String?               @map("contact_phone")
  contactEmail      String?               @map("contact_email")

  // Estado
  status            SupplierStatus        @default(ACTIVE)
  notes             String?

  // Relaciones
  company           Company               @relation(fields: [companyId], references: [id])
  defaultAccount    Account?              @relation(fields: [defaultAccountId], references: [id])
  purchaseInvoices  PurchaseInvoice[]
  purchaseOrders    PurchaseOrder[]
  paymentOrders     PaymentOrder[]
  expenses          Expense[]
  checks            Check[]
  receivingNotes    ReceivingNote[]

  createdBy         String                @map("created_by")
  createdAt         DateTime              @default(now()) @map("created_at")
  updatedAt         DateTime              @updatedAt @map("updated_at")

  @@unique([companyId, code])
  @@unique([companyId, taxId])
  @@map("suppliers")
}

// ============================================
// MÓDULO COMERCIAL - Productos
// ============================================

model ProductCategory {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId   String    @map("company_id") @db.Uuid
  name        String
  description String?
  parentId    String?   @map("parent_id") @db.Uuid

  company     Company           @relation(fields: [companyId], references: [id])
  parent      ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    ProductCategory[] @relation("CategoryHierarchy")
  products    Product[]

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("product_categories")
}

model Product {
  id                  String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId           String          @map("company_id") @db.Uuid
  code                String          // SKU
  name                String
  description         String?
  type                ProductType     @default(PRODUCT)

  // Categorización
  categoryId          String?         @map("category_id") @db.Uuid

  // Unidad de medida
  unitOfMeasure       String          @map("unit_of_measure") @default("UN")  // UN, KG, M, L, etc.

  // Precios
  costPrice           Decimal         @default(0) @map("cost_price") @db.Decimal(12, 2)
  salePrice           Decimal         @default(0) @map("sale_price") @db.Decimal(12, 2)
  salePriceWithTax    Decimal         @default(0) @map("sale_price_with_tax") @db.Decimal(12, 2)

  // Impuestos
  vatRate             Decimal         @default(21) @map("vat_rate") @db.Decimal(5, 2)  // Alícuota de IVA

  // Control de stock
  trackStock          Boolean         @default(true) @map("track_stock")
  minStock            Decimal?        @default(0) @map("min_stock") @db.Decimal(12, 3)
  maxStock            Decimal?        @map("max_stock") @db.Decimal(12, 3)

  // Datos adicionales
  barcode             String?         @unique
  internalCode        String?         @map("internal_code")
  brand               String?
  model               String?

  // Estado
  status              ProductStatus   @default(ACTIVE)

  // Relaciones
  company             Company                 @relation(fields: [companyId], references: [id])
  category            ProductCategory?        @relation(fields: [categoryId], references: [id])
  priceListItems      PriceListItem[]
  stockMovements      StockMovement[]
  warehouseStocks     WarehouseStock[]
  salesInvoiceLines    SalesInvoiceLine[]
  purchaseInvoiceLines PurchaseInvoiceLine[]
  purchaseOrderLines   PurchaseOrderLine[]
  receivingNoteLines   ReceivingNoteLine[]

  createdBy           String          @map("created_by")
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")

  @@unique([companyId, code])
  @@map("products")
}

// ============================================
// MÓDULO COMERCIAL - Listas de Precios
// ============================================

model PriceList {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId   String    @map("company_id") @db.Uuid
  name        String
  description String?
  isDefault   Boolean   @default(false) @map("is_default")
  isActive    Boolean   @default(true) @map("is_active")

  company     Company           @relation(fields: [companyId], references: [id])
  items       PriceListItem[]
  contractors Contractor[]

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("price_lists")
}

model PriceListItem {
  id              String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  priceListId     String     @map("price_list_id") @db.Uuid
  productId       String     @map("product_id") @db.Uuid
  price           Decimal    @db.Decimal(12, 2)
  priceWithTax    Decimal    @map("price_with_tax") @db.Decimal(12, 2)

  priceList       PriceList  @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  product         Product    @relation(fields: [productId], references: [id])

  @@unique([priceListId, productId])
  @@map("price_list_items")
}

// ============================================
// MÓDULO COMERCIAL - Almacenes y Stock
// ============================================

model Warehouse {
  id          String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId   String          @map("company_id") @db.Uuid
  code        String
  name        String
  type        WarehouseType   @default(MAIN)

  // Ubicación
  address     String?
  city        String?
  state       String?

  isActive    Boolean         @default(true) @map("is_active")

  company        Company         @relation(fields: [companyId], references: [id])
  stocks         WarehouseStock[]
  movements      StockMovement[]
  receivingNotes ReceivingNote[]

  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  @@unique([companyId, code])
  @@map("warehouses")
}

model WarehouseStock {
  id              String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  warehouseId     String      @map("warehouse_id") @db.Uuid
  productId       String      @map("product_id") @db.Uuid
  quantity        Decimal     @default(0) @db.Decimal(12, 3)
  reservedQty     Decimal     @default(0) @map("reserved_qty") @db.Decimal(12, 3)  // Reservado en pedidos
  availableQty    Decimal     @default(0) @map("available_qty") @db.Decimal(12, 3) // Disponible = quantity - reservedQty

  warehouse       Warehouse   @relation(fields: [warehouseId], references: [id])
  product         Product     @relation(fields: [productId], references: [id])

  updatedAt       DateTime    @updatedAt @map("updated_at")

  @@unique([warehouseId, productId])
  @@map("warehouse_stocks")
}

model StockMovement {
  id              String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId       String              @map("company_id") @db.Uuid
  warehouseId     String              @map("warehouse_id") @db.Uuid
  productId       String              @map("product_id") @db.Uuid

  type            StockMovementType
  quantity        Decimal             @db.Decimal(12, 3)  // + entrada, - salida

  // Referencia al documento origen
  referenceType   String?             @map("reference_type")  // 'sales_invoice', 'purchase_invoice', 'transfer', etc.
  referenceId     String?             @map("reference_id") @db.Uuid

  notes           String?
  date            DateTime            @default(now())

  company         Company             @relation(fields: [companyId], references: [id])
  warehouse       Warehouse           @relation(fields: [warehouseId], references: [id])
  product         Product             @relation(fields: [productId], references: [id])

  createdBy       String              @map("created_by")
  createdAt       DateTime            @default(now()) @map("created_at")

  @@map("stock_movements")
}

// ============================================
// MÓDULO COMERCIAL - Facturación de Ventas
// ============================================

enum VoucherType {
  FACTURA_A         // Factura A
  FACTURA_B         // Factura B
  FACTURA_C         // Factura C
  NOTA_CREDITO_A    // Nota de Crédito A
  NOTA_CREDITO_B    // Nota de Crédito B
  NOTA_CREDITO_C    // Nota de Crédito C
  NOTA_DEBITO_A     // Nota de Débito A
  NOTA_DEBITO_B     // Nota de Débito B
  NOTA_DEBITO_C     // Nota de Débito C
  RECIBO            // Recibo

  @@map("voucher_type")
}

enum SalesInvoiceStatus {
  DRAFT             // Borrador
  CONFIRMED         // Confirmada
  PAID              // Cobrada
  PARTIAL_PAID      // Parcialmente cobrada
  CANCELLED         // Anulada

  @@map("sales_invoice_status")
}

enum PurchaseInvoiceStatus {
  DRAFT             // Borrador
  CONFIRMED         // Confirmada
  PAID              // Pagada
  PARTIAL_PAID      // Parcialmente pagada
  CANCELLED         // Anulada

  @@map("purchase_invoice_status")
}

enum CashRegisterStatus {
  ACTIVE
  INACTIVE

  @@map("cash_register_status")
}

enum CashMovementType {
  OPENING       // Apertura de sesión
  CLOSING       // Cierre de sesión
  INCOME        // Ingreso de efectivo
  EXPENSE       // Egreso de efectivo
  ADJUSTMENT    // Ajuste manual

  @@map("cash_movement_type")
}

enum SessionStatus {
  OPEN
  CLOSED

  @@map("session_status")
}

enum BankAccountType {
  CHECKING          // Cuenta corriente
  SAVINGS           // Caja de ahorro
  CREDIT            // Cuenta de crédito

  @@map("bank_account_type")
}

enum BankAccountStatus {
  ACTIVE
  INACTIVE
  CLOSED

  @@map("bank_account_status")
}

enum BankMovementType {
  DEPOSIT           // Depósito
  WITHDRAWAL        // Extracción
  TRANSFER_IN       // Transferencia recibida
  TRANSFER_OUT      // Transferencia enviada
  CHECK             // Cheque
  DEBIT             // Débito automático
  FEE               // Comisión bancaria
  INTEREST          // Interés

  @@map("bank_movement_type")
}

enum PaymentMethod {
  CASH              // Efectivo
  CHECK             // Cheque
  TRANSFER          // Transferencia
  DEBIT_CARD        // Tarjeta de débito
  CREDIT_CARD       // Tarjeta de crédito
  ACCOUNT           // Cuenta corriente

  @@map("payment_method")
}

enum ReceiptStatus {
  DRAFT
  CONFIRMED
  CANCELLED

  @@map("receipt_status")
}

enum PaymentOrderStatus {
  DRAFT
  CONFIRMED
  CANCELLED

  @@map("payment_order_status")
}

enum ExpenseStatus {
  DRAFT
  CONFIRMED
  PARTIAL_PAID
  PAID
  CANCELLED

  @@map("expense_status")
}

enum PurchaseOrderStatus {
  DRAFT                  // Borrador
  PENDING_APPROVAL       // Pendiente de aprobacion
  APPROVED               // Aprobada
  PARTIALLY_RECEIVED     // Recibida parcialmente
  COMPLETED              // Completada
  CANCELLED              // Cancelada

  @@map("purchase_order_status")
}

enum PurchaseOrderInvoicingStatus {
  NOT_INVOICED          // Sin facturar
  PARTIALLY_INVOICED    // Facturada parcialmente
  FULLY_INVOICED        // Facturada totalmente

  @@map("purchase_order_invoicing_status")
}

enum ReceivingNoteStatus {
  DRAFT
  CONFIRMED
  CANCELLED

  @@map("receiving_note_status")
}

enum PurchaseOrderInstallmentStatus {
  PENDING    // Sin facturar
  INVOICED   // Factura vinculada
  PAID       // Pagada

  @@map("purchase_order_installment_status")
}

enum WithholdingTaxType {
  IVA
  GANANCIAS
  IIBB
  SUSS

  @@map("withholding_tax_type")
}

// ============================================
// CHEQUES
// ============================================

enum CheckType {
  OWN         // Cheque propio (emitido)
  THIRD_PARTY // Cheque de tercero (recibido)

  @@map("check_type")
}

enum CheckStatus {
  PORTFOLIO // En cartera (terceros recibidos)
  DEPOSITED // Depositado en banco
  CLEARED   // Acreditado
  REJECTED  // Rechazado
  ENDORSED  // Endosado a tercero
  DELIVERED // Entregado (propio emitido)
  CASHED    // Cobrado (propio debitado)
  VOIDED    // Anulado

  @@map("check_status")
}

// ============================================
// PROYECCIONES DE CASHFLOW
// ============================================

enum ProjectionType {
  INCOME
  EXPENSE

  @@map("projection_type")
}

enum ProjectionCategory {
  SALES
  PURCHASES
  SALARIES
  TAXES
  RENT
  SERVICES
  OTHER

  @@map("projection_category")
}

enum ProjectionStatus {
  PENDING
  PARTIAL
  CONFIRMED

  @@map("projection_status")
}

model SalesPointOfSale {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId       String    @map("company_id") @db.Uuid
  number          Int       // Número de punto de venta (0001, 0002, etc.)
  name            String
  isActive        Boolean   @default(true) @map("is_active")

  // Configuración AFIP
  afipEnabled     Boolean   @default(false) @map("afip_enabled")

  company         Company           @relation(fields: [companyId], references: [id])
  salesInvoices   SalesInvoice[]

  createdBy       String    @map("created_by")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@unique([companyId, number])
  @@map("sales_points_of_sale")
}

model SalesInvoice {
  id                String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId         String                @map("company_id") @db.Uuid
  customerId        String                @map("customer_id") @db.Uuid
  pointOfSaleId     String                @map("point_of_sale_id") @db.Uuid

  // Numeración
  voucherType       VoucherType           @map("voucher_type")
  number            Int                   // Número de comprobante
  fullNumber        String                @map("full_number")  // 0001-00000123

  // Fechas
  issueDate         DateTime              @map("issue_date")
  dueDate           DateTime?             @map("due_date")

  // AFIP
  cae               String?               // Código de Autorización Electrónico
  caeExpiryDate     DateTime?             @map("cae_expiry_date")

  // Importes
  subtotal          Decimal               @default(0) @db.Decimal(12, 2)  // Base imponible
  vatAmount         Decimal               @default(0) @map("vat_amount") @db.Decimal(12, 2)
  otherTaxes        Decimal               @default(0) @map("other_taxes") @db.Decimal(12, 2)
  total             Decimal               @default(0) @db.Decimal(12, 2)

  // Observaciones
  notes             String?
  internalNotes     String?               @map("internal_notes")

  // Estado
  status            SalesInvoiceStatus    @default(DRAFT)

  // Documento adjunto
  documentUrl       String?               @map("document_url")
  documentKey       String?               @map("document_key")

  // Relación con contabilidad
  journalEntryId    String?               @map("journal_entry_id") @db.Uuid

  // NC/ND: referencia a factura original (opcional)
  originalInvoiceId String?               @map("original_invoice_id") @db.Uuid

  // Relaciones
  company           Company               @relation(fields: [companyId], references: [id])
  customer          Contractor            @relation(fields: [customerId], references: [id])
  pointOfSale       SalesPointOfSale      @relation(fields: [pointOfSaleId], references: [id])
  lines             SalesInvoiceLine[]
  journalEntry      JournalEntry?         @relation(fields: [journalEntryId], references: [id])
  cashMovements     CashMovement[]
  receiptItems      ReceiptItem[]
  originalInvoice   SalesInvoice?         @relation("SalesInvoiceCreditDebitNotes", fields: [originalInvoiceId], references: [id])
  creditDebitNotes  SalesInvoice[]        @relation("SalesInvoiceCreditDebitNotes")
  creditNoteApplicationsGiven     SalesCreditNoteApplication[] @relation("CreditNoteApplicationsGiven")
  creditNoteApplicationsReceived  SalesCreditNoteApplication[] @relation("CreditNoteApplicationsReceived")
  projectionLinks   ProjectionDocumentLink[]

  createdBy         String                @map("created_by")
  createdAt         DateTime              @default(now()) @map("created_at")
  updatedAt         DateTime              @updatedAt @map("updated_at")

  @@unique([pointOfSaleId, voucherType, number])
  @@map("sales_invoices")
}

model SalesInvoiceLine {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invoiceId       String          @map("invoice_id") @db.Uuid
  productId       String          @map("product_id") @db.Uuid

  description     String
  quantity        Decimal         @db.Decimal(12, 3)
  unitPrice       Decimal         @map("unit_price") @db.Decimal(12, 2)

  // Impuestos
  vatRate         Decimal         @map("vat_rate") @db.Decimal(5, 2)
  vatAmount       Decimal         @map("vat_amount") @db.Decimal(12, 2)

  subtotal        Decimal         @db.Decimal(12, 2)  // quantity * unitPrice
  total           Decimal         @db.Decimal(12, 2)  // subtotal + vatAmount

  invoice         SalesInvoice    @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product         Product         @relation(fields: [productId], references: [id])

  @@map("sales_invoice_lines")
}

// ============================================
// MÓDULO COMERCIAL - Facturación de Compras
// ============================================

model PurchaseInvoice {
  id                String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId         String                  @map("company_id") @db.Uuid
  supplierId        String                  @map("supplier_id") @db.Uuid

  // Datos del comprobante del proveedor
  voucherType       VoucherType             @map("voucher_type")
  pointOfSale       String                  @map("point_of_sale")  // Punto de venta del proveedor
  number            String                  // Número del comprobante
  fullNumber        String                  @map("full_number")    // 0001-00000123

  // Fechas
  issueDate         DateTime                @map("issue_date")
  dueDate           DateTime?               @map("due_date")

  // Validación AFIP
  cae               String?
  validated         Boolean                 @default(false)

  // Importes
  subtotal          Decimal                 @default(0) @db.Decimal(12, 2)
  vatAmount         Decimal                 @default(0) @map("vat_amount") @db.Decimal(12, 2)
  otherTaxes        Decimal                 @default(0) @map("other_taxes") @db.Decimal(12, 2)
  total             Decimal                 @default(0) @db.Decimal(12, 2)

  // Observaciones
  notes             String?

  // Estado
  status            PurchaseInvoiceStatus   @default(DRAFT)

  // Documento adjunto
  documentUrl       String?                 @map("document_url")
  documentKey       String?                 @map("document_key")

  // Relación con contabilidad (futura)
  journalEntryId    String?                 @map("journal_entry_id") @db.Uuid

  // NC/ND: referencia a factura original (opcional)
  originalInvoiceId String?                 @map("original_invoice_id") @db.Uuid

  // Orden de Compra asociada (opcional)
  purchaseOrderId   String?                 @map("purchase_order_id") @db.Uuid

  // Relaciones
  company           Company                 @relation(fields: [companyId], references: [id])
  supplier          Supplier                @relation(fields: [supplierId], references: [id])
  lines             PurchaseInvoiceLine[]
  journalEntry      JournalEntry?           @relation(fields: [journalEntryId], references: [id])
  cashMovements     CashMovement[]
  paymentOrderItems PaymentOrderItem[]
  originalInvoice   PurchaseInvoice?        @relation("PurchaseInvoiceCreditDebitNotes", fields: [originalInvoiceId], references: [id])
  creditDebitNotes  PurchaseInvoice[]       @relation("PurchaseInvoiceCreditDebitNotes")
  creditNoteApplicationsGiven     PurchaseCreditNoteApplication[] @relation("PurchaseCNApplicationsGiven")
  creditNoteApplicationsReceived  PurchaseCreditNoteApplication[] @relation("PurchaseCNApplicationsReceived")
  projectionLinks   ProjectionDocumentLink[]
  purchaseOrderInstallments PurchaseOrderInstallment[]
  purchaseOrder     PurchaseOrder?          @relation(fields: [purchaseOrderId], references: [id])
  receivingNotes    ReceivingNote[]

  createdBy         String                  @map("created_by")
  createdAt         DateTime                @default(now()) @map("created_at")
  updatedAt         DateTime                @updatedAt @map("updated_at")

  @@unique([companyId, supplierId, fullNumber])
  @@index([purchaseOrderId])
  @@map("purchase_invoices")
}

model PurchaseInvoiceLine {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invoiceId       String            @map("invoice_id") @db.Uuid
  productId       String?           @map("product_id") @db.Uuid  // Opcional si es un gasto no inventariable

  description     String
  quantity        Decimal           @db.Decimal(12, 3)
  unitCost        Decimal           @map("unit_cost") @db.Decimal(12, 2)

  // Impuestos
  vatRate         Decimal           @map("vat_rate") @db.Decimal(5, 2)
  vatAmount       Decimal           @map("vat_amount") @db.Decimal(12, 2)

  subtotal        Decimal           @db.Decimal(12, 2)
  total           Decimal           @db.Decimal(12, 2)

  // Vinculación con línea de OC (opcional)
  purchaseOrderLineId String?       @map("purchase_order_line_id") @db.Uuid

  invoice           PurchaseInvoice    @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product           Product?           @relation(fields: [productId], references: [id])
  purchaseOrderLine PurchaseOrderLine? @relation(fields: [purchaseOrderLineId], references: [id])

  @@map("purchase_invoice_lines")
}

// ============================================
// TESORERÍA - CAJAS
// ============================================

model CashRegister {
  id                String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code              String                // Código identificador (ej: "CAJA-01")
  name              String                // Nombre descriptivo
  location          String?               // Ubicación física
  status            CashRegisterStatus    @default(ACTIVE)
  isDefault         Boolean               @default(false) @map("is_default")

  // Relación con contabilidad
  accountId         String?               @map("account_id") @db.Uuid

  // Relaciones
  companyId         String                @map("company_id") @db.Uuid
  company           Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  account           Account?              @relation(fields: [accountId], references: [id])
  sessions          CashRegisterSession[]
  movements         CashMovement[]
  receiptPayments   ReceiptPayment[]
  paymentOrderPayments PaymentOrderPayment[]

  // Auditoría
  createdAt         DateTime              @default(now()) @map("created_at")
  updatedAt         DateTime              @updatedAt @map("updated_at")
  createdBy         String?               @map("created_by")

  @@unique([companyId, code])
  @@index([companyId, status])
  @@map("cash_registers")
}

model CashRegisterSession {
  id                String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionNumber     Int                   @map("session_number")

  // Fechas
  openedAt          DateTime              @default(now()) @map("opened_at")
  closedAt          DateTime?             @map("closed_at")
  status            SessionStatus         @default(OPEN)

  // Montos
  openingBalance    Decimal               @default(0) @map("opening_balance") @db.Decimal(15, 2)
  expectedBalance   Decimal               @default(0) @map("expected_balance") @db.Decimal(15, 2)
  actualBalance     Decimal?              @map("actual_balance") @db.Decimal(15, 2)
  difference        Decimal?              @db.Decimal(15, 2)

  // Notas
  openingNotes      String?               @map("opening_notes") @db.Text
  closingNotes      String?               @map("closing_notes") @db.Text

  // Relaciones
  cashRegisterId    String                @map("cash_register_id") @db.Uuid
  cashRegister      CashRegister          @relation(fields: [cashRegisterId], references: [id], onDelete: Cascade)
  companyId         String                @map("company_id") @db.Uuid
  company           Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  movements         CashMovement[]

  // Usuarios
  openedBy          String                @map("opened_by")
  closedBy          String?               @map("closed_by")

  // Auditoría
  createdAt         DateTime              @default(now()) @map("created_at")
  updatedAt         DateTime              @updatedAt @map("updated_at")

  @@unique([cashRegisterId, sessionNumber])
  @@index([companyId, status])
  @@index([cashRegisterId, status])
  @@map("cash_register_sessions")
}

model CashMovement {
  id                String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type              CashMovementType
  date              DateTime              @default(now())
  amount            Decimal               @db.Decimal(15, 2)
  description       String                @db.Text
  reference         String?

  // Relaciones
  sessionId         String                @map("session_id") @db.Uuid
  session           CashRegisterSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  cashRegisterId    String                @map("cash_register_id") @db.Uuid
  cashRegister      CashRegister          @relation(fields: [cashRegisterId], references: [id], onDelete: Cascade)
  companyId         String                @map("company_id") @db.Uuid
  company           Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Relación opcional con facturas
  salesInvoiceId    String?               @map("sales_invoice_id") @db.Uuid
  salesInvoice      SalesInvoice?         @relation(fields: [salesInvoiceId], references: [id], onDelete: SetNull)
  purchaseInvoiceId String?               @map("purchase_invoice_id") @db.Uuid
  purchaseInvoice   PurchaseInvoice?      @relation(fields: [purchaseInvoiceId], references: [id], onDelete: SetNull)

  // Auditoría
  createdAt         DateTime              @default(now()) @map("created_at")
  updatedAt         DateTime              @updatedAt @map("updated_at")
  createdBy         String                @map("created_by")

  @@index([companyId, date])
  @@index([sessionId, type])
  @@index([cashRegisterId, date])
  @@map("cash_movements")
}

// ============================================
// TESORERÍA - BANCOS
// ============================================

model BankAccount {
  id              String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId       String              @map("company_id") @db.Uuid

  bankName        String              @map("bank_name")
  accountNumber   String              @map("account_number")
  accountType     BankAccountType     @map("account_type")
  cbu             String?             // Clave Bancaria Uniforme
  alias           String?             // Alias para transferencias

  currency        String              @default("ARS")
  balance         Decimal             @default(0) @db.Decimal(15, 2)

  status          BankAccountStatus   @default(ACTIVE)

  // Relación con contabilidad
  accountId       String?             @map("account_id") @db.Uuid

  company         Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  account         Account?            @relation(fields: [accountId], references: [id])
  movements       BankMovement[]
  receiptPayments ReceiptPayment[]
  paymentOrderPayments PaymentOrderPayment[]
  checks          Check[]

  createdBy       String?             @map("created_by")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  @@unique([companyId, accountNumber])
  @@index([companyId, status])
  @@map("bank_accounts")
}

model BankMovement {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  bankAccountId   String            @map("bank_account_id") @db.Uuid
  companyId       String            @map("company_id") @db.Uuid

  type            BankMovementType
  amount          Decimal           @db.Decimal(15, 2)
  date            DateTime
  description     String            @db.Text
  reference       String?

  // Referencia al extracto bancario
  statementNumber String?           @map("statement_number")

  // Referencia a documento origen
  referenceType   String?           @map("reference_type")
  referenceId     String?           @map("reference_id") @db.Uuid

  // Vinculación con documentos de tesorería
  receiptId       String?           @map("receipt_id") @db.Uuid
  paymentOrderId  String?           @map("payment_order_id") @db.Uuid

  // Conciliación
  reconciled      Boolean           @default(false)
  reconciledAt    DateTime?         @map("reconciled_at")
  reconciledBy    String?           @map("reconciled_by")

  bankAccount     BankAccount       @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  receipt         Receipt?          @relation(fields: [receiptId], references: [id])
  paymentOrder    PaymentOrder?     @relation(fields: [paymentOrderId], references: [id])
  check           Check?

  createdBy       String            @map("created_by")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  @@index([companyId, date])
  @@index([bankAccountId, date])
  @@index([reconciled])
  @@map("bank_movements")
}

// ============================================
// TESORERÍA - RECIBOS DE COBRO
// ============================================

model Receipt {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId       String          @map("company_id") @db.Uuid
  customerId      String          @map("customer_id") @db.Uuid

  number          Int
  fullNumber      String          @map("full_number")  // R-00001
  date            DateTime

  totalAmount     Decimal         @map("total_amount") @db.Decimal(15, 2)
  notes           String?         @db.Text

  status          ReceiptStatus   @default(DRAFT)

  // Documento adjunto
  documentUrl     String?         @map("document_url")
  documentKey     String?         @map("document_key")

  // Relación con contabilidad
  journalEntryId  String?         @map("journal_entry_id") @db.Uuid

  company         Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer        Contractor      @relation(fields: [customerId], references: [id])
  items           ReceiptItem[]
  payments        ReceiptPayment[]
  withholdings    ReceiptWithholding[]
  bankMovements   BankMovement[]
  journalEntry    JournalEntry?   @relation(fields: [journalEntryId], references: [id])

  createdBy       String          @map("created_by")
  confirmedBy     String?         @map("confirmed_by")
  confirmedAt     DateTime?       @map("confirmed_at")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  @@unique([companyId, number])
  @@index([companyId, status])
  @@index([customerId, status])
  @@map("receipts")
}

model ReceiptItem {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  receiptId       String        @map("receipt_id") @db.Uuid
  invoiceId       String        @map("invoice_id") @db.Uuid
  amount          Decimal       @db.Decimal(15, 2)

  receipt         Receipt       @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  invoice         SalesInvoice  @relation(fields: [invoiceId], references: [id])

  @@map("receipt_items")
}

model ReceiptPayment {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  receiptId       String          @map("receipt_id") @db.Uuid

  paymentMethod   PaymentMethod   @map("payment_method")
  amount          Decimal         @db.Decimal(15, 2)

  // Datos específicos según método
  cashRegisterId  String?         @map("cash_register_id") @db.Uuid
  bankAccountId   String?         @map("bank_account_id") @db.Uuid
  checkNumber     String?         @map("check_number")
  cardLast4       String?         @map("card_last4")
  reference       String?         // Referencia adicional

  receipt         Receipt         @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  cashRegister    CashRegister?   @relation(fields: [cashRegisterId], references: [id])
  bankAccount     BankAccount?    @relation(fields: [bankAccountId], references: [id])
  check           Check?

  @@map("receipt_payments")
}

// ============================================
// TESORERÍA - ÓRDENES DE PAGO
// ============================================

model PaymentOrder {
  id              String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId       String              @map("company_id") @db.Uuid
  supplierId      String?             @map("supplier_id") @db.Uuid

  number          Int
  fullNumber      String              @map("full_number")  // OP-00001
  date            DateTime

  totalAmount     Decimal             @map("total_amount") @db.Decimal(15, 2)
  notes           String?             @db.Text

  status          PaymentOrderStatus  @default(DRAFT)

  // Documento adjunto
  documentUrl     String?             @map("document_url")
  documentKey     String?             @map("document_key")

  // Relación con contabilidad
  journalEntryId  String?             @map("journal_entry_id") @db.Uuid

  company         Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  supplier        Supplier?           @relation(fields: [supplierId], references: [id])
  items           PaymentOrderItem[]
  payments        PaymentOrderPayment[]
  withholdings    PaymentOrderWithholding[]
  bankMovements   BankMovement[]
  journalEntry    JournalEntry?       @relation(fields: [journalEntryId], references: [id])

  createdBy       String              @map("created_by")
  confirmedBy     String?             @map("confirmed_by")
  confirmedAt     DateTime?           @map("confirmed_at")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  @@unique([companyId, number])
  @@index([companyId, status])
  @@index([supplierId, status])
  @@map("payment_orders")
}

model PaymentOrderItem {
  id              String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  paymentOrderId  String           @map("payment_order_id") @db.Uuid
  invoiceId       String?          @map("invoice_id") @db.Uuid
  expenseId       String?          @map("expense_id") @db.Uuid
  amount          Decimal          @db.Decimal(15, 2)

  paymentOrder    PaymentOrder     @relation(fields: [paymentOrderId], references: [id], onDelete: Cascade)
  invoice         PurchaseInvoice? @relation(fields: [invoiceId], references: [id])
  expense         Expense?         @relation(fields: [expenseId], references: [id])

  @@map("payment_order_items")
}

model PaymentOrderPayment {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  paymentOrderId  String          @map("payment_order_id") @db.Uuid

  paymentMethod   PaymentMethod   @map("payment_method")
  amount          Decimal         @db.Decimal(15, 2)

  // Datos específicos según método
  cashRegisterId  String?         @map("cash_register_id") @db.Uuid
  bankAccountId   String?         @map("bank_account_id") @db.Uuid
  checkNumber     String?         @map("check_number")
  cardLast4       String?         @map("card_last4")
  reference       String?         // Referencia adicional

  paymentOrder    PaymentOrder    @relation(fields: [paymentOrderId], references: [id], onDelete: Cascade)
  cashRegister    CashRegister?   @relation(fields: [cashRegisterId], references: [id])
  bankAccount     BankAccount?    @relation(fields: [bankAccountId], references: [id])
  check           Check?

  @@map("payment_order_payments")
}

// ============================================
// RETENCIONES IMPOSITIVAS
// ============================================

model ReceiptWithholding {
  id                String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  receiptId         String              @map("receipt_id") @db.Uuid
  taxType           WithholdingTaxType  @map("tax_type")
  rate              Decimal             @db.Decimal(5, 2)
  amount            Decimal             @db.Decimal(15, 2)
  certificateNumber String?             @map("certificate_number")

  receipt           Receipt             @relation(fields: [receiptId], references: [id], onDelete: Cascade)

  @@map("receipt_withholdings")
}

model PaymentOrderWithholding {
  id                String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  paymentOrderId    String              @map("payment_order_id") @db.Uuid
  taxType           WithholdingTaxType  @map("tax_type")
  rate              Decimal             @db.Decimal(5, 2)
  amount            Decimal             @db.Decimal(15, 2)
  certificateNumber String?             @map("certificate_number")

  paymentOrder      PaymentOrder        @relation(fields: [paymentOrderId], references: [id], onDelete: Cascade)

  @@map("payment_order_withholdings")
}

// ============================================
// ASIENTOS RECURRENTES
// ============================================

model RecurringEntry {
  id              String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId       String              @map("company_id") @db.Uuid
  name            String              // Nombre descriptivo
  description     String              // Descripción para el asiento generado
  frequency       RecurringFrequency
  startDate       DateTime            @map("start_date")
  endDate         DateTime?           @map("end_date")       // Null = sin vencimiento
  lastGenerated   DateTime?           @map("last_generated")  // Última fecha de generación
  nextDueDate     DateTime            @map("next_due_date")   // Próxima fecha de generación
  isActive        Boolean             @default(true) @map("is_active")
  createdBy       String              @map("created_by")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  company         Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  lines           RecurringEntryLine[]

  @@map("recurring_entries")
}

model RecurringEntryLine {
  id                String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  recurringEntryId  String         @map("recurring_entry_id") @db.Uuid
  accountId         String         @map("account_id") @db.Uuid
  description       String?
  debit             Float          @default(0)
  credit            Float          @default(0)

  recurringEntry    RecurringEntry @relation(fields: [recurringEntryId], references: [id], onDelete: Cascade)
  account           Account        @relation(fields: [accountId], references: [id])

  @@map("recurring_entry_lines")
}

// ============================================
// APLICACIONES DE NOTAS DE CRÉDITO
// ============================================

model SalesCreditNoteApplication {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  creditNoteId String   @map("credit_note_id") @db.Uuid
  invoiceId    String   @map("invoice_id") @db.Uuid
  amount       Decimal  @db.Decimal(15, 2)
  appliedAt    DateTime @default(now()) @map("applied_at")
  companyId    String   @map("company_id") @db.Uuid

  creditNote SalesInvoice @relation("CreditNoteApplicationsGiven", fields: [creditNoteId], references: [id])
  invoice    SalesInvoice @relation("CreditNoteApplicationsReceived", fields: [invoiceId], references: [id])
  company    Company      @relation(fields: [companyId], references: [id])

  @@map("sales_credit_note_applications")
}

model PurchaseCreditNoteApplication {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  creditNoteId String   @map("credit_note_id") @db.Uuid
  invoiceId    String   @map("invoice_id") @db.Uuid
  amount       Decimal  @db.Decimal(15, 2)
  appliedAt    DateTime @default(now()) @map("applied_at")
  companyId    String   @map("company_id") @db.Uuid

  creditNote PurchaseInvoice @relation("PurchaseCNApplicationsGiven", fields: [creditNoteId], references: [id])
  invoice    PurchaseInvoice @relation("PurchaseCNApplicationsReceived", fields: [invoiceId], references: [id])
  company    Company         @relation(fields: [companyId], references: [id])

  @@map("purchase_credit_note_applications")
}

// ============================================
// MÓDULO GASTOS
// ============================================

model ExpenseCategory {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  companyId   String    @map("company_id") @db.Uuid
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  company     Company   @relation(fields: [companyId], references: [id])
  expenses    Expense[]

  @@unique([companyId, name])
  @@map("expense_categories")
}

model Expense {
  id            String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  number        Int
  fullNumber    String          @map("full_number")
  description   String
  amount        Decimal         @db.Decimal(15, 2)
  date          DateTime        @db.Date
  dueDate       DateTime?       @map("due_date") @db.Date
  status        ExpenseStatus   @default(DRAFT)
  notes         String?

  categoryId    String          @map("category_id") @db.Uuid
  supplierId    String?         @map("supplier_id") @db.Uuid
  companyId     String          @map("company_id") @db.Uuid

  // Relación con contabilidad
  journalEntryId String?        @map("journal_entry_id") @db.Uuid

  createdBy     String          @map("created_by")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  category      ExpenseCategory @relation(fields: [categoryId], references: [id])
  supplier      Supplier?       @relation(fields: [supplierId], references: [id])
  company       Company         @relation(fields: [companyId], references: [id])
  journalEntry  JournalEntry?   @relation(fields: [journalEntryId], references: [id])
  attachments   ExpenseAttachment[]
  paymentOrderItems PaymentOrderItem[]
  projectionLinks   ProjectionDocumentLink[]

  @@unique([companyId, number])
  @@index([companyId, status])
  @@map("expenses")
}

model ExpenseAttachment {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  expenseId   String    @map("expense_id") @db.Uuid
  fileName    String    @map("file_name")
  fileKey     String    @map("file_key")
  fileSize    Int?      @map("file_size")
  mimeType    String?   @map("mime_type")
  createdAt   DateTime  @default(now()) @map("created_at")

  expense     Expense   @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  @@map("expense_attachments")
}

// ============================================
// ORDENES DE COMPRA
// ============================================

model PurchaseOrder {
  id                    String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId             String                @map("company_id") @db.Uuid
  supplierId            String                @map("supplier_id") @db.Uuid

  // Numeracion secuencial
  number                Int
  fullNumber            String                @map("full_number")  // OC-00001

  // Fechas
  issueDate             DateTime              @map("issue_date") @db.Date
  expectedDeliveryDate  DateTime?             @map("expected_delivery_date") @db.Date

  // Condiciones
  paymentConditions     String?               @map("payment_conditions") @db.Text
  deliveryAddress       String?               @map("delivery_address")
  deliveryNotes         String?               @map("delivery_notes") @db.Text

  // Importes (calculados desde lineas)
  subtotal              Decimal               @default(0) @db.Decimal(12, 2)
  vatAmount             Decimal               @default(0) @map("vat_amount") @db.Decimal(12, 2)
  total                 Decimal               @default(0) @db.Decimal(12, 2)

  // Observaciones
  notes                 String?               @db.Text

  // Estado
  status                PurchaseOrderStatus   @default(DRAFT)
  invoicingStatus       PurchaseOrderInvoicingStatus @default(NOT_INVOICED) @map("invoicing_status")

  // Aprobacion
  approvedBy            String?               @map("approved_by")
  approvedAt            DateTime?             @map("approved_at")

  // Relaciones
  company               Company               @relation(fields: [companyId], references: [id])
  supplier              Supplier              @relation(fields: [supplierId], references: [id])
  lines                 PurchaseOrderLine[]
  installments          PurchaseOrderInstallment[]
  projectionLinks       ProjectionDocumentLink[]
  receivingNotes        ReceivingNote[]
  purchaseInvoices      PurchaseInvoice[]

  createdBy             String                @map("created_by")
  createdAt             DateTime              @default(now()) @map("created_at")
  updatedAt             DateTime              @updatedAt @map("updated_at")

  @@unique([companyId, number])
  @@index([companyId, status])
  @@map("purchase_orders")
}

model PurchaseOrderLine {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId         String            @map("order_id") @db.Uuid
  productId       String?           @map("product_id") @db.Uuid

  description     String
  quantity        Decimal           @db.Decimal(12, 3)
  unitCost        Decimal           @map("unit_cost") @db.Decimal(12, 2)

  // Impuestos
  vatRate         Decimal           @map("vat_rate") @db.Decimal(5, 2)
  vatAmount       Decimal           @map("vat_amount") @db.Decimal(12, 2)

  subtotal        Decimal           @db.Decimal(12, 2)
  total           Decimal           @db.Decimal(12, 2)

  // Recepcion parcial
  receivedQty     Decimal           @default(0) @map("received_qty") @db.Decimal(12, 3)
  // Facturacion parcial
  invoicedQty     Decimal           @default(0) @map("invoiced_qty") @db.Decimal(12, 3)

  order                PurchaseOrder        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product              Product?             @relation(fields: [productId], references: [id])
  receivingNoteLines   ReceivingNoteLine[]
  purchaseInvoiceLines PurchaseInvoiceLine[]

  @@map("purchase_order_lines")
}

model PurchaseOrderInstallment {
  id                  String                            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId           String                            @map("company_id") @db.Uuid
  orderId             String                            @map("order_id") @db.Uuid
  number              Int
  dueDate             DateTime                          @map("due_date") @db.Date
  amount              Decimal                           @db.Decimal(12, 2)
  status              PurchaseOrderInstallmentStatus    @default(PENDING)
  purchaseInvoiceId   String?                           @map("purchase_invoice_id") @db.Uuid
  notes               String?                           @db.Text

  company             Company           @relation(fields: [companyId], references: [id])
  order               PurchaseOrder     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  purchaseInvoice     PurchaseInvoice?  @relation(fields: [purchaseInvoiceId], references: [id])

  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")

  @@unique([orderId, number])
  @@index([companyId, orderId])
  @@map("purchase_order_installments")
}

// ============================================
// REMITOS DE RECEPCION
// ============================================

model ReceivingNote {
  id                  String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId           String              @map("company_id") @db.Uuid
  supplierId          String              @map("supplier_id") @db.Uuid
  warehouseId         String              @map("warehouse_id") @db.Uuid

  // Numeracion secuencial
  number              Int
  fullNumber          String              @map("full_number") // RR-00001

  // Documento origen (opcionales, puede ser suelto)
  purchaseOrderId     String?             @map("purchase_order_id") @db.Uuid
  purchaseInvoiceId   String?             @map("purchase_invoice_id") @db.Uuid

  // Fechas
  receptionDate       DateTime            @map("reception_date") @db.Date

  // Observaciones
  notes               String?             @db.Text

  // Estado
  status              ReceivingNoteStatus @default(DRAFT)

  // Relaciones
  company             Company             @relation(fields: [companyId], references: [id])
  supplier            Supplier            @relation(fields: [supplierId], references: [id])
  warehouse           Warehouse           @relation(fields: [warehouseId], references: [id])
  purchaseOrder       PurchaseOrder?      @relation(fields: [purchaseOrderId], references: [id])
  purchaseInvoice     PurchaseInvoice?    @relation(fields: [purchaseInvoiceId], references: [id])
  lines               ReceivingNoteLine[]

  createdBy           String              @map("created_by")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  @@unique([companyId, number])
  @@index([companyId, status])
  @@index([purchaseOrderId])
  @@index([purchaseInvoiceId])
  @@map("receiving_notes")
}

model ReceivingNoteLine {
  id                    String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  receivingNoteId       String              @map("receiving_note_id") @db.Uuid
  productId             String              @map("product_id") @db.Uuid

  description           String
  quantity              Decimal             @db.Decimal(12, 3)

  // Referencia a linea de OC (para tracking de receivedQty)
  purchaseOrderLineId   String?             @map("purchase_order_line_id") @db.Uuid

  // Observaciones de la linea
  notes                 String?             @db.Text

  receivingNote         ReceivingNote       @relation(fields: [receivingNoteId], references: [id], onDelete: Cascade)
  product               Product             @relation(fields: [productId], references: [id])
  purchaseOrderLine     PurchaseOrderLine?  @relation(fields: [purchaseOrderLineId], references: [id])

  @@map("receiving_note_lines")
}

// ============================================
// CHEQUES
// ============================================

model Check {
  id                    String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId             String       @map("company_id") @db.Uuid
  type                  CheckType
  status                CheckStatus  @default(PORTFOLIO)

  // Datos del cheque
  checkNumber           String       @map("check_number")
  bankName              String       @map("bank_name")
  branch                String?
  accountNumber         String?      @map("account_number")
  amount                Decimal      @db.Decimal(15, 2)
  issueDate             DateTime     @map("issue_date")
  dueDate               DateTime     @map("due_date")

  // Librador y beneficiario
  drawerName            String       @map("drawer_name")
  drawerTaxId           String?      @map("drawer_tax_id")
  payeeName             String?      @map("payee_name")

  // Relaciones con terceros
  customerId            String?      @map("customer_id") @db.Uuid
  supplierId            String?      @map("supplier_id") @db.Uuid

  // Relaciones con documentos de tesorería
  receiptPaymentId      String?      @unique @map("receipt_payment_id") @db.Uuid
  paymentOrderPaymentId String?      @unique @map("payment_order_payment_id") @db.Uuid

  // Relación con banco (al depositar)
  bankAccountId         String?      @map("bank_account_id") @db.Uuid
  bankMovementId        String?      @unique @map("bank_movement_id") @db.Uuid

  // Endoso
  endorsedToName        String?      @map("endorsed_to_name")
  endorsedToTaxId       String?      @map("endorsed_to_tax_id")
  endorsedAt            DateTime?    @map("endorsed_at")

  // Rechazo
  rejectedAt            DateTime?    @map("rejected_at")
  rejectionReason       String?      @map("rejection_reason")

  // Depósito y acreditación
  depositedAt           DateTime?    @map("deposited_at")
  clearedAt             DateTime?    @map("cleared_at")

  notes                 String?      @db.Text

  // Relations
  company               Company      @relation(fields: [companyId], references: [id])
  customer              Contractor?  @relation(fields: [customerId], references: [id])
  supplier              Supplier?    @relation(fields: [supplierId], references: [id])
  bankAccount           BankAccount? @relation(fields: [bankAccountId], references: [id])
  bankMovement          BankMovement? @relation(fields: [bankMovementId], references: [id])
  receiptPayment        ReceiptPayment? @relation(fields: [receiptPaymentId], references: [id])
  paymentOrderPayment   PaymentOrderPayment? @relation(fields: [paymentOrderPaymentId], references: [id])

  createdBy             String       @map("created_by")
  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @updatedAt @map("updated_at")

  @@index([companyId, type, status])
  @@index([companyId, dueDate])
  @@map("checks")
}

// ============================================
// PROYECCIONES DE CASHFLOW
// ============================================

model CashflowProjection {
  id          String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId   String              @map("company_id") @db.Uuid
  type        ProjectionType
  category    ProjectionCategory
  description String
  amount      Decimal             @db.Decimal(15, 2)
  date        DateTime            @db.Date
  isRecurring Boolean             @default(false) @map("is_recurring")
  notes           String?             @db.Text
  status          ProjectionStatus    @default(PENDING)
  confirmedAmount Decimal             @default(0) @map("confirmed_amount") @db.Decimal(15, 2)

  company         Company             @relation(fields: [companyId], references: [id])
  documentLinks   ProjectionDocumentLink[]
  createdBy       String              @map("created_by")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  @@index([companyId, date])
  @@index([companyId, status])
  @@map("cashflow_projections")
}

model ProjectionDocumentLink {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId         String   @map("company_id") @db.Uuid
  projectionId      String   @map("projection_id") @db.Uuid
  amount            Decimal  @db.Decimal(15, 2)

  // FK polimórfico — solo uno será non-null
  salesInvoiceId    String?  @map("sales_invoice_id") @db.Uuid
  purchaseInvoiceId String?  @map("purchase_invoice_id") @db.Uuid
  expenseId         String?  @map("expense_id") @db.Uuid
  purchaseOrderId   String?  @map("purchase_order_id") @db.Uuid

  notes             String?  @db.Text

  // Relations
  company           Company             @relation(fields: [companyId], references: [id])
  projection        CashflowProjection  @relation(fields: [projectionId], references: [id], onDelete: Cascade)
  salesInvoice      SalesInvoice?       @relation(fields: [salesInvoiceId], references: [id])
  purchaseInvoice   PurchaseInvoice?    @relation(fields: [purchaseInvoiceId], references: [id])
  expense           Expense?            @relation(fields: [expenseId], references: [id])
  purchaseOrder     PurchaseOrder?      @relation(fields: [purchaseOrderId], references: [id])

  createdBy         String   @map("created_by")
  createdAt         DateTime @default(now()) @map("created_at")

  @@index([projectionId])
  @@index([salesInvoiceId])
  @@index([purchaseInvoiceId])
  @@index([expenseId])
  @@index([purchaseOrderId])
  @@map("projection_document_links")
}
